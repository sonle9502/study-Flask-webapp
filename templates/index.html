<!-- templates/index.html -->
{% extends 'base.html' %}

{% block title %}Home - To-Do App{% endblock %}

{% block content %}
<div class="jumbotron">
    <h1 class="display-4">Welcome to the To-Do App</h1>
    <p class="lead">Manage your tasks efficiently with our simple and intuitive interface.</p>
    <hr class="my-4">
    <form class="form-inline my-2 my-lg-0" action="{{ url_for('search') }}" method="GET">
        <input class="form-control mr-sm-2" type="search" placeholder="Search tasks..." name="query">
        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
        <a class="btn btn-primary btn-lg ml-auto" href="{{ url_for('add') }}" role="button">Add a New Task</a>
    </form>
</div>

<div class="list-group">
    <div class="list-group-item">
        <a href="{{ url_for('send_email') }}" class="btn btn-secondary btn-sm">send_email</a>
    </div>
    {% for todo in todos %}
    <div class="list-group-item">
        <p>Content : {{  todo.content }} </p>
        <p>Detail : {{ todo.description }} </p>
        <p>Created_at : {{ todo.created_at.strftime('%Y-%m-%d %H:%M:%S') }} </p>
        <p>Due date : {{ todo.due_date }} </p>
        <p>
            {% if todo.images %}
                {% for image in todo.images %}
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="gallery-item">
                        <a href="{{ url_for('image', image_id=image.id) }}" target="_blank">
                            <img src="{{ url_for('image', image_id=image.id) }}" alt="Image {{ image.id }}" class="img-thumbnail">
                        </a>
                        <button class="delete-button" onclick="deleteImage({{ image.id }})">&times;</button>
                    </div>
                {% endfor %}
            {% endif %}
            <form action="{{ url_for('upload_images', id=todo.id) }}" method="post" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="file" name="files" multiple>
                <input type="submit" value="Upload">
            </form>
        </p>   
        <a href="{{ url_for('delete', id=todo.id) }}" class="btn btn-danger btn-sm" onclick="return confirmDelete()">Delete</a>
        <a href="{{ url_for('detail', id=todo.id) }}" class="btn btn-secondary btn-sm">Detail</a>
    </div>
    {% endfor %}
</div>
<script>
    function getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    }

    function confirmDelete() {
    return confirm("Are you sure you want to delete this item?");
}

    function deleteImage(imageId) {
        if (confirm('Are you sure you want to delete this image?')) {
            fetch(`/delete_image/${imageId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()  // Include CSRF token in the headers
                },
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to delete image.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete image.');
            });
        }
    }
</script>
    
{% endblock %}
